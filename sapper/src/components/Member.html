
<div class="buttons has-addons is-right">
  <a href='/members/{member.name}/edit' class="button">Edit</a>
</div>

<div class="tile is-ancestor is-vertical">
  <div class='tile is-parent'>
    <div class="tile is-child box">
      <h1 class='title'>
        {member.name}
        <button
          class="button is-small"
          on:click="open('identity')"
        >
          <span class="icon">
            <i class="fas fa-edit"></i>
          </span>
        </button>
      </h1>
      {#if edit.has('identity')}
        <Form
          on:submit="submit('identity', event)"
          on:cancel="close('identity')"
          loading={submitting.has('identity')}
          data={member}
          fields={[{
            name: 'fullname',
            required: true,
            label: 'Full name',
            placeholder: 'Wikkert Olbodo',
          }, {
            type: 'email',
            name: 'email',
            required: true,
            label: 'Email',
            placeholder: 'wikkert@wolbodo.nl',
          }, {
            name: 'phone',
            label: 'Phone',
            placeholder: '+31 000 0000 000',
          }]}
        />
      {:else}
        {#if member.fullname}
          <p>{member.fullname}</p>
        {/if}
        {#if member.email}
          <a href='mailto:{member.email}'>{member.email}</a>
        {/if}
        {#if member.phone}
          <a href='tel:{member.phone}'>{member.phone}</a>
        {/if}
      {/if}
    </div>

    <div class="tile is-child box">
      <h1 class='title'>
        Address
        <button
          class="button is-small"
          on:click="open('address')"
        >
          <span class="icon">
            <i class="fas fa-edit"></i>
          </span>
        </button>
      </h1>
      {#if edit.has('address')}
        <Form
          on:submit="submit('address', event)"
          on:cancel="close('address')"
          loading={submitting.has('address')}
          data={member}
          fields={[{
            name: 'streetname',
            required: true,
            label: 'Street',
            placeholder: 'Verwersdijk',
          }, {
            name: 'housenumber',
            required: true,
            label: 'Number',
            placeholder: '102',
          }, {
            name: 'housenumberaddon',
            label: 'Number addon',
            placeholder: ''
          }, {
            name: 'zipcode',
            label: 'Zipcode',
            placeholder: '2611 NK',
          }, {
            name: 'city',
            label: 'City',
            placeholder: 'Delft',
          }, {
            name: 'country',
            label: 'Country',
            placeholder: 'Nederland',
          }]}
        />
      {:else}
        <p>{member.streetname} {member.housenumber} {member.housenumberaddon || ''}</p>
        <p>{member.zipcode} {member.city}</p>
        <p>{member.country}</p>
      {/if}
    </div>
  </div>

  <div class='tile is-parent'>
    <div class='tile is-child box is-6'>
      <h1 class='title'>
        Roles
      </h1>
      <Select
        Item={RoleSelectItem}
        items={roles}
        isMulti={true}
        isWaiting={rolesLoading}
        placeholder='Select roles'
        getSelectionLabel={(option) => option.name}
        getOptionLabel={(option) => option.name}
        bind:selectedValue='selectedRoles'
      ></Select>

      <div class="buttons is-right">
        <button on:click='saveRoles()' class="button is-primary" class:is-loading='rolesSaving' disabled='{!rolesDirty}'>
          Save
        </button>
      </div>
    </div>

    {#if isSelf}
      <div class='tile is-child box is-6'>
        <form on:submit|preventDefault|stopPropagation='savePassword(password)'>
          <h1 class='title'>
            Password
          </h1>
          <div class="field has-addons">
            <p class="control">
              {#if showPassword}
                <input disabled={passwordSaving} class="input" type='text' bind:value='password'>
              {:else}
                <input disabled={passwordSaving} class="input" type='password' bind:value='password'>
              {/if}
            </p>
            <p class="control">
              <button type='button' class="button" on:click='set({ showPassword: !showPassword})'>
                <span class="icon is-small">
                  <i class="fa fa-{showPassword ? 'eye-slash' : 'eye'}" />
                </span>
              </button>
            </p>
            <p class="control">
              <button type='submit' class="button is-primary" class:is-loading='passwordSaving'>
                Save
              </button>
            </p>
          </div>
        </form>
      </div>
    {/if}
  </div>
</div>

<!-- <pre>{JSON.stringify(member, null, 2)}</pre> -->

<style>
  .tile.is-child {
    padding: 0.5rem;
  }
  .title {
    display: flex;
    justify-content: space-between;
  }
</style>


<script>
  import gql from 'graphql-tag'
  import RoleSelectItem from './RoleSelectItem.html'

  export default {
    computed: {
      memberRoles: ({ member }) => member.member_roles.map(ur => ur.role),
      isSelf: ({ $user, member: { name } }) => $user && ($user.name === name),
      rolesDirty: ({ selectedRoles = [], memberRoles }) => (
        (selectedRoles.length !== memberRoles.length)
        || selectedRoles.some(r => !memberRoles.some(mr => mr.name === r.name))
      )
    },
    components: {
      Form: './Form.html',
      Select: 'svelte-select',
    },
    data () {
      return {
        RoleSelectItem,
        showPassword: false,
        password: '',
        edit: new Set(),
        submitting: new Set(),
        roles: [],
        rolesLoading: true
      }
    },
    methods: {
      async submit(name, data) {
        const { member, edit, submitting } = this.get()
        if (data.size !== 0) {
          console.log("Submit:", name, data)
          submitting.add(name)
          this.set({ submitting })

          await this.store.updateMember(
            member.id,
            Object.fromEntries(data.entries())
          )
          submitting.delete(name)
        }
        edit.delete(name)
        this.set({ submitting, edit })
      },
      async saveRoles () {
        this.set({ rolesSaving: true })

        const { selectedRoles = [], memberRoles, member } = this.get()
        const toDelete = memberRoles.filter(mr => !selectedRoles.some(sr => sr.name === mr.name))
        const toAdd = selectedRoles.filter(sr => !memberRoles.some(mr => sr.name === mr.name))

        const res = await this.store.gqlMutation({
          mutation: gql`mutation updateRoles($memberId: Int!, $delRoleIds: [Int!]!, $addRoles: [member_role_insert_input!]!) {
            delete_member_role(where:{
              member_id: { _eq: $memberId },
              role_id: { _in: $delRoleIds }
            }) {
              affected_rows
            }
            insert_member_role(objects:$addRoles) {
              affected_rows
            }
          }`,
          variables: {
            memberId: member.id,
            delRoleIds: toDelete.map(r => r.id),
            addRoles: toAdd.map(r => ({
              member_id: member.id,
              role_id: r.value
            }))
          }
        })
        this.set({ rolesSaving: false })
      },
      open(name) {
        console.log("Open form:", name)
        const { edit } = this.get()
        edit.add(name)
        this.set({ edit })
      },
      async savePassword (password) {
        const { member } = this.get()
        this.set({ passwordSaving: true })
        console.log("New password:", password)

        await this.store.updateMember(
          member.id,
          { password }
        )
        this.set({ passwordSaving: false, password: '' })
      },
      close(name) {
        const { edit } = this.get()
        edit.delete(name)
        this.set({ edit })
      }
    },
    oncreate () { 
      this.store.allRoles()
        .then(roles => roles.map(({ id, name, description }) => ({ value: id, name, description })))
        .then(roles => this.set({ rolesLoading: false, roles }))
        .then(roles => console.log("Roles loaded:", roles))
        .catch(e => console.error(e))

      const { member } = this.get()
      this.set({
        selectedRoles: member.member_roles.map(ur => ur.role).map(r => ({...r, value: r.id}))
      })
    }
  }
</script>