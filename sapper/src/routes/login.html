
<section>
  <form on:submit='login(event)'>
    <EmailField horizontal
      disabled={loading}
      label='Email'
      value={email || ''}
      on:change="set({ email: event })"
    />
    <PasswordField horizontal
      disabled={loading}
      label='Password'
      value={password || ''}
      on:change="set({ password: event })"
    />


    <div class="buttons is-right">
      <button type=submit class="button is-link" class:is-loading='loading' disabled="{loading}">Login</button>
    </div>
  </form>

  {#if loginResult}
    loginResult:
    <pre>
      {JSON.stringify(loginResult, null, 2)}
    </pre>
  {/if}

  {#if memberData}
    memberData:
    <pre>
      {JSON.stringify(memberData, null, 2)}
    </pre>
  {/if}
</section>

<style>
  pre {
    white-space: pre-wrap;
    word-break: break-all;
  }
</style>

<script>

  import {
    EmailField,
    PasswordField
  } from 'svelte-bulma-forms/module'

  import gql from 'graphql-tag'

  export default {
    data() {
      return {
        email: 'dexter@example.org',
        password: 'dexter',
        loginResult: undefined,
        memberData: undefined
      }
    },
    components: {
      EmailField, PasswordField
    },
    methods: {
      async login(e) {
        const { email, password } = this.get()

        e.preventDefault()
        e.stopPropagation()
        try {
          this.set({ loading: true })
          const res = await fetch('/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              email,
              password
            })
          })

          const data = await res.json()
          this.set({
            loginResult: {
              status: res.status,
              data
            }
          })

          this.set({ loading: false })
          this.store.set({
            token: data.jwt,
            user: data.user
          })

        } catch (e) {
          console.error(e)
        }
      }
    }
  }
</script>