<div class="field is-grouped">
  <p class="control">
    <a href='/members/create' class="button is-primary">
      <span class="icon">
        <i class="fas fa-plus"></i>
      </span>
      <span>Create</span>
    </a>
  </p>
</div>

<div class="control has-icons-left has-icons-right">
  <input class="input is-medium" type="text" placeholder="Zoek..." bind:value='filter'>
  <span class="icon is-left">
    <i class="fas fa-search"></i>
  </span>
</div>

{#if error}
  <div class="error notification is-danger">
    <h3 class='title'>Error</h3>
    {JSON.stringify(error, null, 2)}
  </div>
{/if}

{#if !members}
  <p>Loading</p>
{:else}
  <Table
    filter={filter}
    data={members}
    columns={columns}
    rowUrl={row => `/members/${row.name}`}
  />
{/if}

<style>
  .error.notification {
    white-space: pre-wrap;
    margin: 1em 0;
  }
</style>

<script>
import gql from 'graphql-tag';

  import MemberNameField from 'src/components/MemberNameField.html'
  import MemberRolesField from 'src/components/MemberRolesField.html'
  import { loadQueries, stopQueries, preloadQueries } from 'src/lib/queries'

const queries = [{
  type: 'subscription',
  query: gql`subscription {
    members: active_member {
      id name email phone 
      fullname
      member_roles {
        role {
          id
          name
        }
      }
    }
  }`,
  success({ data }) {
    this.set({ members: data.members })
  },
  error(err) { this.set({ error: err }) }
}]

export default {
  components: {
    Table: 'src/components/Table.html'
  },
  data() {
    return {
      filter: '',
      // getMembers: subscription(GET_MEMBERS),
      columns: [
        { name: 'Name', field: 'name', component: MemberNameField },
        { name: 'Full Name', field: 'fullname' },
        { name: 'Email', field: 'email' },
        { name: 'Phone', field: 'phone' },
        { name: 'Roles', field: 'member_roles', component: MemberRolesField },
      ]
    }
  },
  oncreate() {
    loadQueries(this, queries)
  },
  ondestroy() {
    stopQueries(this)
  },
  async preload () {
    const { loggedIn } = this.store.get()
    
    if (!loggedIn) {
      return this.redirect(302, '/login')
    } else {

      return await preloadQueries(this.store, queries)
    }
  }
}
</script>