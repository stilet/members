<Error :error />  

{#if !member}
  <p>Loading</p>
{:else}
  <Member {member} />
{/if}

<script>
  import gql from 'graphql-tag'
  import { loadQueries, stopQueries, preloadQueries } from 'src/lib/queries'
    
  const queries = [{
    type: 'subscription',
    query: gql`subscription ($slug: String) {
      members: find_member(args:{slug:$slug}) {
        id
        name
        fullname
        
        email
        phone

        address
        zipcode
        city
        country

        validity

        member_roles {
          validity
          role {
            id name
          }
        }
      }
    }`,
    success({ data }) {
      this.set({ member: data.members[0] })
    },
    error(err) { this.set({ error: err }) }
  }]

  export default {
    components: {
      Member: 'src/components/Member.html',
      Error: 'src/components/Error.html'
      
    },
    oncreate() {
      const { params } = this.get()
      loadQueries(this, queries, { params })
    },
    ondestroy() {
      stopQueries(this)
    },
    async preload ({ params }) {
      const { loggedIn } = this.store.get()

      if (!loggedIn) {
        return this.redirect(302, '/login')
      }

      return await preloadQueries(this.store, queries, { params })
    }
  }
</script>