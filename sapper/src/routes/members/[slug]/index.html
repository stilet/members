
{#if error}
  <div class="error notification is-danger">
    <h3 class='title'>Error</h3>
    {JSON.stringify(error, null, 2)}
  </div>
{/if}

<pre>
  {JSON.stringify($tokenParsed, null, 2)}
</pre>
{#if !member}
  <p>Loading</p>
{:else}
  <Member {member} />
{/if}

<script>
  import gql from 'graphql-tag'
  import { loadQueries, stopQueries, preloadQueries } from 'src/lib/queries'
    
  const queries = [{
    type: 'subscription',
    query: gql`subscription ($slug: String) {
      members: find_member(args:{slug:$slug}) {
        id
        name
        fullname
        email

        housenumber
        housenumberaddon
        city
        country

        phone
        streetname
        zipcode

        member_roles {
          role {
            id name
          }
        }
      }
    }`,
    success({ data }) {
      this.set({ member: data.members[0] })
    },
    error(err) { this.set({ error: err }) }
  }]

  export default {
    components: {
      Member: 'src/components/Member.html',
    },
    oncreate() {
      const { params } = this.get()
      loadQueries(this, queries, params)
    },
    ondestroy() {
      stopQueries(this)
    },
    async preload ({ params }) {
      const { loggedIn, userSlug } = this.store.get()

      console.log("Got params:", params, userSlug)
      
      if (!loggedIn) {
        return this.redirect(302, '/login')
      } else {

        return await preloadQueries(this.store, queries, params)
      }
    }
  }
</script>