
{#if error}
  <div class="error notification is-danger">
    <h3 class='title'>Error</h3>
    {JSON.stringify(error, null, 2)}
  </div>
{/if}

{#if !member}
  <p>Loading</p>
{:else}
  <MemberEdit {member} {loading} on:submit='handleUpdate(event)'/>
{/if}


<script>
  import gql from 'graphql-tag';
  import { loadQueries, stopQueries, preloadQueries } from 'src/lib/queries'

  const queries = [{
    type: 'subscription',
    query: gql`subscription ($slug: String) {
      members: find_member(args:{slug:$slug}) {
        id
        name
        fullname
        
        email
        phone

        address
        zipcode
        city
        country

        validity

        member_roles {
          role {
            name
          }
        }
      }
    }`,
    success({ data }) {
      this.set({ member: data.members[0] })
    },
    error(err) { this.set({ error: err }) }
  }]

  export default {
    components: {
      MemberEdit: 'src/components/MemberEdit.html'
    },
    methods: {
      async handleUpdate (data) {
        const { member } = this.get()
        console.log("Should handle update:", data)

        this.set({ loading: true })
        await this.store.updateMember(member.id, data)
        this.store.notify('success', `Member (${member.name}) updated`)
        this.set({ loading: false })
      }
    },
    oncreate() {
      const { params } = this.get()
      loadQueries(this, queries, { params })
    },
    ondestroy() {
      stopQueries(this)
    },
    async preload ({ params }) {
      const { loggedIn, permissions, userSlug } = this.store.get()
      
      if (!loggedIn) {
        return this.redirect(302, '/login')
      }

      if (!(permissions.includes('member:update') || (userSlug == params.slug))) {
        console.error("No permissions")
        return this.redirect(302, '/')
      }

      return await preloadQueries(this.store, queries, { params })
    }
  }
</script>