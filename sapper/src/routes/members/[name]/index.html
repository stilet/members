
{#if error}
  <div class="error notification is-danger">
    <h3 class='title'>Error</h3>
    {JSON.stringify(error, null, 2)}
  </div>
{/if}

{#if !member}
  <p>Loading</p>
{:else}
  <Member {member} />
{/if}

<script>
  import gql from 'graphql-tag';

    
  const intoQuery = ({ definitions, ...rest }) => (
    {
      definitions: definitions.map(
        def => ({
          ...def,
          operation: 'query',
        })),
      ...rest
    }
  )

  const queries = [{
    type: 'subscription',
    query: gql`subscription ($name: String) {
      members: active_member(where:{name: { _eq: $name }}, limit: 1) {
        name
        fullname
        email

        housenumber
        housenumberaddon
        city
        country

        phone
        streetname
        zipcode

        member_roles {
          role {
            name
          }
        }
      }
    }`,
    success({ data }) {
      console.log("Received update:", data, this)
      this.set({ member: data.members[0] })
    },
    error(err) { this.set({ error: err }) }
  }]

  export default {
    components: {
      Member: 'src/components/Member.html',
    },
    oncreate() {
      const { graphqlClient } = this.store.get()
      const { params } = this.get()
      // params do not update the subscription now

      this.subscriptions = []

      for (let query of queries) {
        console.log("Creating:", query)
        if (query.type === 'subscription') {
          this.subscriptions.push(
            graphqlClient.subscribe({
              query: query.query,
              variables: params
            })
            .subscribe({
              next: d => query.success.call(this, d),
              error: e => query.error.call(this, e)
            })
          )
        } else {
          console.warn("Unmanaged query:", query)
        }
      }
    },
    async preload ({ params }) {
      const { graphqlClient } = this.store.get()

      console.log("Got params:", params)

      const data = {}

      for (let query of queries) {
        if (query.type === 'subscription') {

          const res = await graphqlClient.query({
            query: intoQuery(query.query),
            variables: params
          })

          query.success.call({
            set(newState) { Object.assign(data, newState) }
          }, res)
        }
      }

      return data
    }
  }
</script>