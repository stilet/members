<script context="module">
  export async function preload({ params }) {
    const { loggedIn } = this.store.get()

    if (!loggedIn) {
      return this.redirect(302, '/login')
    }

    return await preloadQueries(this.store, queries, { params })
  }
</script>

<script>
  import { onDestroy, onMount } from 'svelte';

  import gql from 'graphql-tag'
  import { loadQueries, stopQueries, preloadQueries } from 'src/lib/queries'
    
  const queries = [{
    type: 'subscription',
    query: gql`subscription ($slug: String) {
      members: find_member(args:{slug:$slug}) {
        id
        name
        firstname
        lastname
        
        email
        phone

        address
        zipcode
        city
        country

        validity

        isMember: member_roles_aggregate(where:{role:{name:{_eq:"member"}}}) {
          aggregate {
            count
          }
        }
        isOldMember: all_member_roles(where:{
          role:{name:{_eq:"member"}},
          validity:{_lt:"[NOW,]"}
        }) {
          validity
        }
        isBoard: member_roles_aggregate(where:{role:{name:{_eq:"board"}}}) {
          aggregate {
            count
          }
        }

        member_roles {
          role {
            id name
          }
        }

        all_member_roles {
          validity
          role {
            id name
          }
        }
      }
    }`,
    success({ data }) {
      this.set({ member: data.members.map(({isMember, isOldMember, isBoard, ...member}) => ({
        ...member,
        isMember: isMember.aggregate.count > 0,
        isBoard: isBoard.aggregate.count > 0,
        isOldMember: isOldMember.length > 0
      }))[0] })
    },
    error(err) { this.set({ error: err }) }
  }]

  export let error;
  export let member;
  export let params;

  import Member from 'src/components/Member.html';
  import Error from 'src/components/Error.html';

  onMount(() => {
    loadQueries(this, queries, { params })
  });

  onDestroy(() => {
    stopQueries(this)
  });
</script>

<Error {error} />  

{#if !member}
  <p>Loading</p>
{:else}
  <Member {member} />
{/if}