<script context="module">
  import { get } from 'svelte/store'
  import { loggedIn }  from 'src/stores/auth'

  export function preload({ query }) {
    // Check login status, and redirect to next of necessary
    // const { loggedIn } = this.store.get()
    const { host, uri } = query

    console.log("User logged in:", get(loggedIn))

    if (get(loggedIn)) {
      if (host) {
        this.redirect("302", `https://${host}${uri}`)
      } else {
        this.redirect("302", '/')
      }
    } else {
      return {
        host, uri
      }
    }
  }
</script>

<script>
  import gql from 'graphql-tag'

  import { login } from 'src/stores/auth'

  import InputField from 'src/components/InputField.html'
  import Error from 'src/components/Error.html';

  // import {
  //   EmailField,
  //   PasswordField
  // } from 'svelte-bulma-forms/module'

  // import { goto } from '../../../__sapper__/client.js'

  let email = '';
  let password = '';

  let loading;
  let error;
  let host;
  let uri;

  async function doLogin(event) {
    event.preventDefault()
    event.stopPropagation()

    loading = true
    try {
      console.log("Logging in:", email, password)
      await login(email, password)
    } catch (e) {
      console.error("Error logging in:", e)
    }
    loading = false
  }
</script>

<section>
  <form on:submit='{doLogin}'>
    <InputField horizontal
      type='email'
      disabled={loading}
      label='Email'
      value={email || ''}
      on:change="{event => {
        console.log(event)
        email = event.detail.value
      }}"
    />
    <InputField horizontal
      type='password'
      disabled={loading}
      label='Password'
      value={password || ''}
      validate={{
        message: 'Your password must be at least 5 characters long',
        rule: /\S{5,}/
      }}
      on:change="{event => password = event.detail.value}"
    />
    <div class="buttons is-right">
      <button type=submit class="button is-link" class:is-loading='{loading}' disabled="{loading}">Login</button>
    </div>

    <a href='/login/reset' class='is-link'>Forgot your password?</a>
  </form>

  <Error {error} />  

</section>