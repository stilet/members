<script context="module">
  import { get } from 'svelte/store'
  import { loggedIn }  from 'src/stores/auth'

  export function preload({ query }) {
    // Check login status, and redirect to next of necessary
    // const { loggedIn } = this.store.get()
    const { host, uri } = query

    console.log("User logged in:", get(loggedIn))

    if (get(loggedIn)) {
      if (host) {
        this.redirect("302", `https://${host}${uri}`)
      } else {
        this.redirect("302", '/')
      }
    } else {
      return {
        host, uri
      }
    }
  }
</script>

<script>
  import gql from 'graphql-tag'

  import { notify } from 'src/stores/notifications'
  
  import InputField from 'src/components/InputField.html'
  import Error from 'src/components/Error.html';

  // [svelte-upgrade suggestion]
  // manually refactor all references to __this
  const __this = {};

  // import {
  //   EmailField,
  //   PasswordField
  // } from 'svelte-bulma-forms/module'

  // import { goto } from '../../../__sapper__/client.js'

  export let loading;
  export let email = '';
  export let password = '';
  export let error;
  export let host;
  export let uri;


  // [svelte-upgrade suggestion]
  // review these functions and remove unnecessary 'export' keywords
  export async function login(e) {

    e.preventDefault()
    e.stopPropagation()
    try {
      loading = true
      const res = await fetch('/auth/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          email,
          password
        })
      })

      const data = await res.json()

      loading = false
      if (res.ok) {
        notify('info', 'Login okay')

        // __this.store.set({
        //   token: data.token,
        //   user: data.user,
        //   refreshToken: data.refreshToken
        // })

        // if (host) {
        //   goto(`https://${host}${uri}`, { replaceState: true })
        // } else {
        //   goto('/', { replaceState: true })
        // }

      } else {
        error = data
        notify('error', 'Incorrect login details')
      }
    } catch (e) {
      console.error(e)
    }
  }
</script>

<section>
  <form on:submit='{login}'>
    <InputField horizontal
      type='email'
      disabled={loading}
      label='Email'
      value={email || ''}
      on:change="{event => email = event.detail.value}"
    />
    <InputField horizontal
      type='password'
      disabled={loading}
      label='Password'
      value={password || ''}
      validate={{
        message: 'Your password must be at least 5 characters long',
        rule: /\S{5,}/
      }}
      on:change="{event => password = event.detail.value}"
    />
    <div class="buttons is-right">
      <button type=submit class="button is-link" class:is-loading='{loading}' disabled="{loading}">Login</button>
    </div>

    <a href='/login/reset' class='is-link'>Forgot your password?</a>
  </form>

  <Error {error} />  

</section>