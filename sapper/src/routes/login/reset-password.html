<script context="module">
  export function preload({ query }) {
    return {
      token: query.token
    }
  }
</script>

<script>
  import { PasswordField } from 'svelte-bulma-forms/module'
  import { goto } from '../../../__sapper__/client.js'

  export let loading = false;
  export let password1 = '';
  export let password2 = '';
  export let error;
  export let token;

  import Error from 'src/components/Error.html';

  // [svelte-upgrade suggestion]
  // review these functions and remove unnecessary 'export' keywords
  export async function submit() {
    loading = true

    try {
      if (password1 !== password2) {
        throw new Error('Somethings off')
      }
      
      const res = await fetch('/auth/password-reset', {
        method: "POST",
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          password: password1,
          token
        })
      })

      if (res.ok) {
        goto('/', { replaceState: true })
      } else {
        error = await res.json()
      }

    } catch (e) {
      console.error("Error happened:", e)  
      error = e
    }
    loading = false
  }
</script>

<section>
  <h1 class='title'>Configure your new password.</h1>
  <form on:submit|preventDefault|stopPropagation="{submit}">
    <PasswordField horizontal
      disabled={loading}
      label='Password'
      value={password1 || ''}
      validate={{
        message: 'Your password must be at least 8 characters long',
        rule: /\S{8,}/
      }}
      on:change="{event => password1 = event}"
    />
    <PasswordField horizontal
      disabled={loading}
      label='Password check'
      value={password2 || ''}
      validate={{
        message: 'Your password is not the same',
        rule: new RegExp(`^${password1}$`)
      }}
      on:change="{event => password2 = event}"
    />

    <div class="buttons is-right">
      <button type=submit class="button is-link" class:is-loading='{loading}' disabled="{loading}">Save password</button>
    </div>
  </form>

  <Error :error />  

</section>